name: Build and Push Docker Images

on:
    push:
        branches:
            - main
            - develop
        paths:
            - 'payment-service/**'
            - 'user-service/**'
            - 'notification-service/**'
            - '.github/workflows/docker-build-push.yml'
    pull_request:
        branches:
            - main

env:
    REGISTRY: $ {{ secrets.ACR_URL }}
    REGISTRY_USERNAME: $ {{ secrets.ACR_USERNAME }}
    REGISTRY_PASSWORD: $ {{ secrets.ACR_PASSWORD }}

jobs:
    build-payment:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Azure Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ env.REGISTRY_USERNAME }}
                  password: ${{ env.REGISTRY_PASSWORD }}

            - name: Build and push Payment Service image
              uses: docker/build-push-action@v5
              with:
                  context: ./payment-service
                  push: ${{ github.event_name == 'push' }}
                  tags: |
                      ${{ env.REGISTRY }}/payment:${{ github.run_number }}
                      ${{ env.REGISTRY }}/payment:latest
                  cache-from: type=registry,ref=${{ env.REGISTRY }}/payment:buildcache
                  cache-to: type=registry,ref=${{ env.REGISTRY }}/payment:buildcache,mode=max

            - name: Scan Payment Service image
              run: |
                docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
                    aquasec/trivy image \
                    --exit-code 0 \
                    --severity HIGH,CRITICAL \
                    ${{ env.REGISTRY }}/payment:${{ github.run_number }}

    build-user:
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Azure Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ env.REGISTRY_USERNAME }}
                  password: ${{ env.REGISTRY_PASSWORD }}
            
            - name: Build and push User Service image
              uses: docker/build-push-action@v5
              with:
                  context: ./user-service
                  push: ${{ github.event_name == 'push' }}
                  tags: |
                      ${{ env.REGISTRY }}/user:${{ github.run_number }}
                      ${{ env.REGISTRY }}/user:latest
                  cache-from: type=registry,ref=${{ env.REGISTRY }}/user:buildcache
                  cache-to: type=registry,ref=${{ env.REGISTRY }}/user:buildcache,mode=max

            - name: Scan User Service image
              run: |
                docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
                    aquasec/trivy image \
                    --exit-code 0 \
                    --severity HIGH,CRITICAL \
                    ${{ env.REGISTRY }}/user:${{ github.run_number }}
        
    build-notification:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Azure Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ env.REGISTRY_USERNAME }}
                  password: ${{ env.REGISTRY_PASSWORD }}

            - name: Build and push Notification Service image
              uses: docker/build-push-action@v5
              with:
                  context: ./notification-service
                  push: ${{ github.event_name == 'push' }}
                  tags: |
                      ${{ env.REGISTRY }}/notification:${{ github.run_number }}
                      ${{ env.REGISTRY }}/notification:latest
                  cache-from: type=registry,ref=${{ env.REGISTRY }}/notification:buildcache
                  cache-to: type=registry,ref=${{ env.REGISTRY }}/notification:buildcache,mode=max

            - name: Scan Notification Service image
              run: |
                docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
                    aquasec/trivy image \
                    --exit-code 0 \
                    --severity HIGH,CRITICAL \
                    ${{ env.REGISTRY }}/notification:${{ github.run_number }}